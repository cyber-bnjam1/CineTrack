<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CineTrack</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- LAYOUT --- */
        html { background-color: #0f172a; height: 100%; }
        body {
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: row; 
        }

        /* --- SIDEBAR --- */
        .glass-sidebar {
            width: 64px;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: 20px;
            z-index: 40;
            flex-shrink: 0;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        .nav-btn.active {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
        }
        .nav-btn:active { transform: scale(0.9); }

        /* --- CONTENT --- */
        .main-content {
            flex: 1;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- DASHBOARD --- */
        .dashboard-bar {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 12px 0;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .dash-item { text-align: center; flex: 1; position: relative; }
        .dash-item:not(:last-child)::after {
            content: ''; position: absolute; right: 0; top: 20%; height: 60%; width: 1px; background: rgba(255,255,255,0.1);
        }
        .dash-val { font-size: 16px; font-weight: 800; color: white; line-height: 1.2; }
        .dash-lbl { font-size: 9px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- GRID --- */
        .smart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        /* --- PROVIDERS --- */
        .provider-logo { width: 36px; height: 36px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }

        /* --- UTILS --- */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pt-safe { padding-top: max(20px, env(safe-area-inset-top)); }
        
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .click-bounce:active { transform: scale(0.95); transition: 0.1s; }
        
        .btn-gradient {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .google-btn { background: white; color: #1f2937; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; transition: all 0.2s; }
    </style>
</head>
<body>

    <nav class="glass-sidebar">
        <div class="mb-6 mt-4 text-blue-500"><i class="ph-fill ph-film-strip text-3xl"></i></div>
        <div class="flex-1 flex flex-col w-full items-center">
            <button onclick="window.switchTab('home')" id="nav-home" class="nav-btn active"><i class="ph-bold ph-house text-xl"></i></button>
            <button onclick="window.switchTab('movies')" id="nav-movies" class="nav-btn"><i class="ph-bold ph-film-strip text-xl"></i></button>
            <button onclick="window.switchTab('series')" id="nav-series" class="nav-btn"><i class="ph-bold ph-television text-xl"></i></button>
            <button onclick="window.switchTab('stats')" id="nav-stats" class="nav-btn"><i class="ph-bold ph-chart-pie-slice text-xl"></i></button>
            <button onclick="window.switchTab('search')" id="nav-search" class="nav-btn"><i class="ph-bold ph-magnifying-glass text-xl"></i></button>
        </div>
        <button onclick="window.toggleSettings()" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:text-white transition mt-auto active:bg-white/10"><i class="ph-bold ph-gear text-lg"></i></button>
    </nav>

    <div class="main-content">
        <header class="pt-safe px-5 pb-2 flex justify-between items-center z-30 bg-gradient-to-b from-[#0f172a] via-[#0f172a]/80 to-transparent">
            <div><h1 id="page-title" class="text-xl font-black tracking-tight text-white flex items-center gap-2">À voir <span id="online-indicator" class="hidden w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></span></h1></div>
            <div id="header-avatar" class="hidden w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center text-[10px] font-bold ring-2 ring-white/10">U</div>
        </header>

        <div id="view-library" class="flex-1 overflow-y-auto hide-scroll p-4 pb-10">
            <div class="dashboard-bar mb-6 animate-pop">
                <div class="dash-item"><p id="stat-movies" class="dash-val">0</p><p class="dash-lbl">Films Vus</p></div>
                <div class="dash-item"><p id="stat-eps" class="dash-val">0</p><p class="dash-lbl">Épisodes</p></div>
                <div class="dash-item"><p id="stat-time" class="dash-val text-blue-400">0h</p><p class="dash-lbl">Temps</p></div>
            </div>
            <div id="resume-section" class="hidden mb-6 animate-pop">
                <h2 class="text-[10px] font-bold text-blue-400 uppercase mb-3 flex items-center gap-1.5 px-1 tracking-wider"><i class="ph-fill ph-play-circle"></i> Reprendre</h2>
                <div id="resume-list" class="flex gap-3 overflow-x-auto hide-scroll pb-2 px-1"></div>
            </div>
            <div id="library-grid" class="smart-grid animate-pop"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-12 opacity-50">
                <div class="w-14 h-14 bg-slate-800 rounded-full flex items-center justify-center mb-3"><i class="ph-duotone ph-film-strip text-2xl text-gray-400"></i></div>
                <p class="text-xs font-bold text-gray-400">Rien à afficher</p>
                <button onclick="window.switchTab('search')" class="mt-4 px-5 py-2 bg-blue-600 rounded-full text-xs font-bold click-bounce">Ajouter</button>
            </div>
        </div>

        <div id="view-search" class="hidden flex-1 overflow-y-auto hide-scroll p-4 pb-10">
            <div class="relative mb-6">
                <input type="text" id="search-input" placeholder="Chercher un film ou une série..." class="w-full bg-slate-800 text-white p-3.5 pl-11 pr-10 rounded-xl border border-white/10 focus:border-blue-500 outline-none text-base font-bold shadow-inner transition-colors">
                <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg"></i>
                <button id="search-clear" onclick="window.clearSearch()" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1 rounded-full active:bg-white/10 transition"><i class="ph-bold ph-x-circle text-xl"></i></button>
            </div>
            <div id="search-loader" class="hidden flex justify-center py-10"><i class="ph-duotone ph-spinner animate-spin text-3xl text-blue-500"></i></div>
            <div id="search-results" class="space-y-2"></div>
        </div>

        <div id="view-stats" class="hidden flex-1 overflow-y-auto hide-scroll p-4 pb-10">
            <div class="mb-8 animate-pop">
                <h2 class="text-sm font-bold text-gray-400 uppercase mb-3 px-1 tracking-widest"><i class="ph-fill ph-calendar-blank"></i> Prochaines Sorties</h2>
                <div id="calendar-list" class="space-y-2"><p class="text-xs text-gray-500 italic p-2">Chargement...</p></div>
            </div>
            <div class="mb-8 animate-pop" style="animation-delay: 100ms">
                <h2 class="text-sm font-bold text-gray-400 uppercase mb-3 px-1 tracking-widest"><i class="ph-fill ph-chart-pie-slice"></i> Répartition</h2>
                <div class="bg-slate-800/50 p-4 rounded-2xl border border-white/5 h-64 relative"><canvas id="typeChart"></canvas></div>
            </div>
            <div class="mb-8 animate-pop" style="animation-delay: 200ms">
                <h2 class="text-sm font-bold text-gray-400 uppercase mb-3 px-1 tracking-widest"><i class="ph-fill ph-tag"></i> Top Genres</h2>
                <div id="genre-bars" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-50 hidden transition-opacity duration-300" onclick="window.closeModal()"></div>
    <div id="modal-sheet" class="fixed bottom-0 right-0 w-full sm:w-[500px] h-[95vh] bg-[#0f172a] rounded-t-[32px] sm:rounded-l-[32px] sm:rounded-tr-none z-50 transform translate-y-full sm:translate-x-full sm:translate-y-0 transition-transform duration-300 flex flex-col shadow-2xl border-l border-white/10">
        <div class="relative w-full h-64 flex-shrink-0">
            <img id="m-img" src="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-transparent"></div>
            
            <button onclick="window.closeModal()" class="absolute top-10 right-5 w-10 h-10 bg-black/40 backdrop-blur rounded-full flex items-center justify-center text-white click-bounce shadow-lg border border-white/10 z-50">
                <i class="ph-bold ph-x text-lg"></i>
            </button>
            <div class="absolute bottom-0 w-full p-6">
                <h2 id="m-title" class="text-2xl font-black leading-tight mb-2 text-white drop-shadow-lg">Titre</h2>
                <div class="flex gap-2 text-xs font-bold text-gray-300">
                    <span id="m-year" class="bg-white/10 px-2 py-0.5 rounded backdrop-blur">2024</span>
                    <span id="m-type" class="bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded backdrop-blur border border-blue-500/20">FILM</span>
                    <span id="m-runtime" class="bg-white/10 px-2 py-0.5 rounded backdrop-blur">120m</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 bg-[#0f172a]">
            <div id="providers-ui" class="hidden mb-6">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-2">Disponible sur</h3>
                <div id="providers-list" class="flex gap-2 overflow-x-auto hide-scroll pb-2"></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-8">
                <button onclick="window.setStatus('watched')" id="btn-watched" class="py-3.5 bg-slate-800 rounded-xl font-bold text-gray-400 flex items-center justify-center gap-2 click-bounce transition border border-white/5"><i class="ph-bold ph-check-circle"></i> Vu</button>
                <button onclick="window.setStatus('towatch')" id="btn-towatch" class="py-3.5 bg-slate-800 rounded-xl font-bold text-gray-400 flex items-center justify-center gap-2 click-bounce transition border border-white/5"><i class="ph-bold ph-eye"></i> À voir</button>
            </div>
            <div id="series-ui" class="hidden mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Saisons</h3>
                    <span id="status-badge" class="hidden text-[10px] font-black bg-gradient-to-r from-yellow-400 to-orange-500 text-black px-2 py-0.5 rounded shadow-lg shadow-orange-500/20">TERMINÉE</span>
                </div>
                <div id="season-list" class="flex gap-2 overflow-x-auto hide-scroll mb-3"></div>
                <div id="episode-list" class="space-y-1.5"></div>
            </div>
            <div id="rating-ui" class="hidden mb-8 bg-slate-900/50 p-4 rounded-xl text-center border border-white/5">
                <p class="text-[10px] font-bold text-gray-500 uppercase mb-3">Ma Note</p>
                <div class="flex justify-center gap-3">
                    <i onclick="window.rate(1)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(2)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(3)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(4)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(5)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                </div>
            </div>
            <div class="mb-12">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-widest">Casting</h3>
                <div id="cast-list" class="flex gap-3 overflow-x-auto hide-scroll"></div>
            </div>
            <div class="mb-24">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-widest">Tu aimeras aussi</h3>
                <div id="reco-list" class="flex gap-3 overflow-x-auto hide-scroll"></div>
            </div>
        </div>

        <div class="absolute bottom-6 left-6 right-6 z-20">
            <button onclick="window.saveItem()" class="w-full py-3.5 btn-gradient text-white font-black text-base rounded-xl shadow-xl click-bounce flex items-center justify-center gap-2">Enregistrer <i class="ph-bold ph-arrow-right"></i></button>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-6" onclick="window.toggleSettings()">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl p-6 border border-white/10 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-lg font-bold mb-4 text-white">Réglages</h2>
            <div id="user-info" class="mb-6 hidden text-center">
                <div class="w-14 h-14 rounded-full bg-blue-500 mx-auto mb-2 flex items-center justify-center text-xl font-bold text-white uppercase" id="user-avatar">?</div>
                <p id="user-email" class="text-xs font-bold text-white"></p>
                <p class="text-[10px] text-green-400 mt-1 uppercase font-bold">● Connecté</p>
            </div>
            <div class="space-y-3">
                <button id="btn-login" onclick="window.loginGoogle()" class="w-full py-3 google-btn rounded-xl text-xs shadow-lg"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4"> Se connecter avec Google</button>
                <button id="btn-logout" onclick="window.logoutGoogle()" class="hidden w-full py-3 bg-slate-800 rounded-xl font-bold text-xs text-gray-300 border border-white/10">Se déconnecter</button>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="window.exportData()" class="py-3 bg-slate-800 rounded-xl font-bold text-xs text-blue-400 border border-white/5"><i class="ph-bold ph-download"></i> Sauvegarder</button>
                    <button onclick="document.getElementById('file-input').click()" class="py-3 bg-slate-800 rounded-xl font-bold text-xs text-blue-400 border border-white/5"><i class="ph-bold ph-upload"></i> Restaurer</button>
                    <input type="file" id="file-input" class="hidden" accept=".json" onchange="window.importData(this)">
                </div>
                <hr class="border-white/10 my-4">
                <button onclick="window.resetAll()" class="w-full py-3 text-red-500 font-bold text-xs border border-red-500/20 rounded-xl">Vider le cache</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBasFR8ZaxPt05lU6TgGEz_Qf-hnzV6_No", authDomain: "cinetrack-dd7c1.firebaseapp.com", projectId: "cinetrack-dd7c1", storageBucket: "cinetrack-dd7c1.firebasestorage.app", messagingSenderId: "816079795855", appId: "1:816079795855:web:d5e620ca45d7ed685222fa" };
        let app, auth, db, user = null; try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); console.log("Firebase OK"); } catch(e) { console.warn("Firebase Init Error", e); }

        const API_KEY = '3fd2be6f0c70a2a598f084ddfb75487c'; const BASE_URL = 'https://api.themoviedb.org/3'; const IMG_URL = 'https://image.tmdb.org/t/p/w300'; const IMG_HD = 'https://image.tmdb.org/t/p/w780'; const DB_KEY = 'cinetrack_v31_buttonfix';
        let library = JSON.parse(localStorage.getItem(DB_KEY)) || []; let tempItem, tempStatus, tempRating, tempProgress, tempNext, tempEpsWatched; let currentTab = 'home'; let seasonCache = {}; let myChart = null;

        window.loginGoogle = async () => { if(!auth) return alert("Err Firebase"); try { await signInWithPopup(auth, new GoogleAuthProvider()); window.toggleSettings(); } catch(e) { alert(e.message); } };
        window.logoutGoogle = async () => { if(!auth) return; await signOut(auth); user = null; updateUserUI(); alert("Déconnecté"); window.toggleSettings(); };
        if(auth) { onAuthStateChanged(auth, async (u) => { user = u; updateUserUI(); if (user) { try { const snap = await getDoc(doc(db, "users", user.uid)); if (snap.exists()) { library = snap.data().library || []; localStorage.setItem(DB_KEY, JSON.stringify(library)); renderLibrary(); refreshStats(); } else { saveToCloud(); } } catch(e) { console.error(e); } } }); }
        async function saveToCloud() { if(user && db) try { await setDoc(doc(db, "users", user.uid), { library }); } catch(e){} }
        function updateUserUI() { const elIds = ['online-indicator','header-avatar','user-info','btn-logout']; const hideIds = ['btn-login']; elIds.forEach(id => document.getElementById(id).classList.toggle('hidden', !user)); hideIds.forEach(id => document.getElementById(id).classList.toggle('hidden', !!user)); if(user) { document.getElementById('user-email').innerText = user.email; document.getElementById('user-avatar').innerText = user.email[0].toUpperCase(); document.getElementById('header-avatar').innerText = user.email[0].toUpperCase(); } }

        window.switchTab = (t) => { ['home','movies','series','search','stats'].forEach(k => document.getElementById('nav-'+k).classList.remove('active')); document.getElementById('nav-'+t).classList.add('active'); ['view-search','view-library','view-stats'].forEach(id => document.getElementById(id).classList.add('hidden')); const titles = { 'home': 'À voir', 'movies': 'Films Vus', 'series': 'Séries Finies', 'search': 'Recherche', 'stats': 'Statistiques' }; document.getElementById('page-title').innerHTML = `${titles[t]} <span id="online-indicator" class="${user?'':'hidden'} w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></span>`; if(t === 'search') { document.getElementById('view-search').classList.remove('hidden'); setTimeout(()=>document.getElementById('search-input').focus(), 100); } else if(t === 'stats') { document.getElementById('view-stats').classList.remove('hidden'); renderStatsView(); } else { currentTab = t; document.getElementById('view-library').classList.remove('hidden'); renderLibrary(); } };

        function renderLibrary() { const grid = document.getElementById('library-grid'); const resumeSection = document.getElementById('resume-section'); const resumeList = document.getElementById('resume-list'); grid.innerHTML = ''; resumeList.innerHTML = ''; let itemsToShow = []; if (currentTab === 'home') { itemsToShow = library.filter(i => i.status === 'towatch' || i.status === 'series_active'); const resumeItems = library.filter(i => i.type === 'tv' && i.status === 'series_active'); if (resumeItems.length > 0) { resumeSection.classList.remove('hidden'); resumeItems.forEach(i => { const d = document.createElement('div'); d.className = "flex-shrink-0 w-48 h-28 bg-slate-800 rounded-xl relative overflow-hidden snap-start shadow-lg border border-white/5 cursor-pointer"; const img = i.backdrop ? IMG_HD+i.backdrop : (i.poster ? IMG_URL+i.poster : ''); d.innerHTML = `<img src="${img}" class="w-full h-full object-cover opacity-60" onerror="this.style.display='none'"><div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div><div class="absolute bottom-2 left-3 right-3"><p class="text-[9px] font-bold text-blue-400 uppercase mb-0.5">S${i.next.s} EP${i.next.e}</p><p class="text-white font-bold truncate text-xs">${i.title}</p></div>`; d.onclick = () => openDetails(i.tmdb_id, 'tv'); resumeList.appendChild(d); }); } else { resumeSection.classList.add('hidden'); } } else { resumeSection.classList.add('hidden'); if (currentTab === 'movies') itemsToShow = library.filter(i => i.type === 'movie' && i.status === 'watched'); else if (currentTab === 'series') itemsToShow = library.filter(i => i.type === 'tv' && i.status === 'finished'); } if (itemsToShow.length === 0) { document.getElementById('empty-state').classList.remove('hidden'); } else { document.getElementById('empty-state').classList.add('hidden'); itemsToShow.forEach(i => { const d = document.createElement('div'); d.className = "relative aspect-[2/3] bg-slate-800 rounded-xl overflow-hidden shadow-lg animate-pop cursor-pointer"; const img = i.poster ? IMG_URL+i.poster : ''; let badge = ''; if(i.status === 'towatch') badge = `<div class="absolute top-2 right-2 w-2 h-2 bg-blue-500 rounded-full shadow-[0_0_8px_#3b82f6]"></div>`; if(i.status === 'finished') badge = `<div class="absolute top-2 right-2 px-1 py-0.5 bg-yellow-400 text-black text-[7px] font-black rounded shadow">FINI</div>`; d.innerHTML = `<img src="${img}" class="w-full h-full object-cover opacity-90" onerror="this.style.display='none'">${badge}<button class="absolute inset-0" onclick="window.openDetails('${i.tmdb_id}','${i.type}')"></button>`; grid.appendChild(d); }); } }

        async function renderStatsView() { const calList = document.getElementById('calendar-list'); calList.innerHTML = '<div class="flex justify-center p-2"><i class="ph-duotone ph-spinner animate-spin text-blue-500"></i></div>'; const activeSeries = library.filter(i => i.type === 'tv' && i.status === 'series_active'); if(activeSeries.length > 0) { calList.innerHTML = ''; for(const s of activeSeries) { try { const r = await fetch(`${BASE_URL}/tv/${s.tmdb_id}?api_key=${API_KEY}&language=fr-FR`); const d = await r.json(); if(d.next_episode_to_air) { const date = new Date(d.next_episode_to_air.air_date).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}); const div = document.createElement('div'); div.className = "flex justify-between items-center p-3 bg-slate-800/50 rounded-xl border border-white/5"; div.innerHTML = `<div class="flex items-center gap-3"><img src="${IMG_URL+s.poster}" class="w-8 h-10 rounded bg-black object-cover"><div class="text-xs"><p class="font-bold text-white">${s.title}</p><p class="text-blue-400">S${d.next_episode_to_air.season_number} E${d.next_episode_to_air.episode_number}</p></div></div><div class="text-right"><p class="text-xs font-bold text-white">${date}</p></div>`; calList.appendChild(div); } } catch(e){} } if(calList.innerHTML === '') calList.innerHTML = '<p class="text-xs text-gray-500 italic p-2 text-center">Aucun épisode à venir détecté.</p>'; } else { calList.innerHTML = '<p class="text-xs text-gray-500 italic p-2 text-center">Aucune série en cours.</p>'; } const ctx = document.getElementById('typeChart').getContext('2d'); if(myChart) myChart.destroy(); const movies = library.filter(i=>i.type==='movie').length; const series = library.filter(i=>i.type==='tv').length; myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Films', 'Séries'], datasets: [{ data: [movies, series], backgroundColor: ['#3b82f6', '#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'white', font: {size: 10} } } } } }); document.getElementById('genre-bars').innerHTML = ` <div class="flex items-center gap-2"><span class="text-xs w-16">À Voir</span><div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-blue-500" style="width:${(library.filter(i=>i.status==='towatch').length/library.length)*100}%"></div></div></div> <div class="flex items-center gap-2"><span class="text-xs w-16">Terminés</span><div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-green-500" style="width:${(library.filter(i=>['watched','finished'].includes(i.status)).length/library.length)*100}%"></div></div></div> `; }

        let timer; const searchInput = document.getElementById('search-input'); const clearBtn = document.getElementById('search-clear'); searchInput.addEventListener('input', (e)=>{ clearTimeout(timer); if(e.target.value.length>0) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden'); if(e.target.value.length>2) { document.getElementById('search-loader').classList.remove('hidden'); document.getElementById('search-results').innerHTML=''; timer=setTimeout(()=>doSearch(e.target.value),500); } else { document.getElementById('search-results').innerHTML=''; document.getElementById('search-loader').classList.add('hidden'); } }); window.clearSearch = () => { searchInput.value = ''; clearBtn.classList.add('hidden'); document.getElementById('search-results').innerHTML = ''; document.getElementById('search-loader').classList.add('hidden'); searchInput.focus(); }; async function doSearch(q){ try{ const r=await fetch(`${BASE_URL}/search/multi?api_key=${API_KEY}&language=fr-FR&query=${encodeURIComponent(q)}&include_adult=false`); const d=await r.json(); document.getElementById('search-loader').classList.add('hidden'); const l=document.getElementById('search-results'); l.innerHTML=''; d.results.filter(i=>(i.media_type==='movie'||i.media_type==='tv')&&i.poster_path).forEach(i=>{ const div=document.createElement('div'); div.className="flex items-center gap-3 p-2 bg-slate-800/50 rounded-xl border border-white/5 cursor-pointer active:scale-95 transition"; div.innerHTML=`<img src="${IMG_URL+i.poster_path}" class="w-10 h-14 rounded-lg object-cover bg-black"><div class="flex-1"><h4 class="font-bold text-white text-sm leading-tight">${i.media_type==='movie'?i.title:i.name}</h4><p class="text-[10px] text-gray-400 mt-0.5 uppercase font-bold">${i.media_type==='movie'?'Film':'Série'} • ${(i.release_date||i.first_air_date||'').slice(0,4)}</p></div>`; div.onclick=()=>window.openDetails(i.id,i.media_type); l.appendChild(div); }); }catch(e){} }

        window.openDetails = async (id, type) => { const [d,c,p,r] = await Promise.all([ fetch(`${BASE_URL}/${type}/${id}?api_key=${API_KEY}&language=fr-FR`).then(r=>r.json()), fetch(`${BASE_URL}/${type}/${id}/credits?api_key=${API_KEY}&language=fr-FR`).then(r=>r.json()), fetch(`${BASE_URL}/${type}/${id}/watch/providers?api_key=${API_KEY}`).then(r=>r.json()), fetch(`${BASE_URL}/${type}/${id}/recommendations?api_key=${API_KEY}&language=fr-FR`).then(r=>r.json()) ]); tempItem={...d,type,tmdb_id:d.id.toString(),cast:c.cast?.slice(0,10)||[]}; const ex=library.find(i=>i.tmdb_id===tempItem.tmdb_id); if(ex){tempStatus=ex.status;tempRating=ex.rating||0;tempProgress=ex.progress||{s:1,e:0};tempNext=ex.next||{s:1,e:1};tempEpsWatched=ex.epsWatched||0;} else{tempStatus='towatch';tempRating=0;tempProgress={s:1,e:0};tempNext={s:1,e:1};tempEpsWatched=0;} document.getElementById('m-title').innerText=type==='movie'?d.title:d.name; document.getElementById('m-year').innerText=(type==='movie'?d.release_date:d.first_air_date)?.slice(0,4); document.getElementById('m-type').innerText=type==='movie'?'FILM':'SÉRIE'; document.getElementById('m-runtime').innerText=type==='movie'?d.runtime+'m':(d.episode_run_time?.[0]||45)+'m'; document.getElementById('m-img').src=d.backdrop_path?IMG_HD+d.backdrop_path:IMG_URL+d.poster_path; const cl=document.getElementById('cast-list'); cl.innerHTML=''; tempItem.cast.forEach(a=>{if(a.profile_path)cl.innerHTML+=`<div class="flex-shrink-0 w-14 text-center"><img src="${IMG_URL+a.profile_path}" class="w-12 h-12 rounded-full object-cover mx-auto mb-1 bg-slate-800"><p class="text-[8px] text-gray-400 truncate">${a.name}</p></div>`;}); const pl=document.getElementById('providers-list'); const pu=document.getElementById('providers-ui'); pl.innerHTML=''; if(p.results && p.results.FR && p.results.FR.flatrate) { pu.classList.remove('hidden'); p.results.FR.flatrate.forEach(pv => { pl.innerHTML+=`<img src="${IMG_URL+pv.logo_path}" class="provider-logo" title="${pv.provider_name}">`; }); } else { pu.classList.add('hidden'); } const rl=document.getElementById('reco-list'); rl.innerHTML=''; r.results.slice(0,6).forEach(rec => { if(rec.poster_path) { const div = document.createElement('div'); div.className="flex-shrink-0 w-24 cursor-pointer"; div.innerHTML=`<img src="${IMG_URL+rec.poster_path}" class="w-full h-36 rounded-lg object-cover bg-slate-800"><p class="text-[9px] text-gray-400 truncate mt-1 text-center">${rec.title||rec.name}</p>`; div.onclick=()=>window.openDetails(rec.id, type); rl.appendChild(div); } }); if(type==='tv'){ document.getElementById('series-ui').classList.remove('hidden'); document.getElementById('rating-ui').classList.add('hidden'); seasonCache={}; initSeasons(d.number_of_seasons); document.getElementById('status-badge').classList.toggle('hidden', tempStatus!=='finished'); } else { document.getElementById('series-ui').classList.add('hidden'); updateStatusUI(); } document.getElementById('modal-overlay').classList.remove('hidden'); const sheet=document.getElementById('modal-sheet'); sheet.classList.remove('translate-y-full','sm:translate-x-full'); };
        window.closeModal = () => { const sheet=document.getElementById('modal-sheet'); if(window.innerWidth>=640)sheet.classList.add('sm:translate-x-full'); else sheet.classList.add('translate-y-full'); setTimeout(()=>document.getElementById('modal-overlay').classList.add('hidden'),300); };
        window.setStatus = (s) => { tempStatus=s; updateStatusUI(); if(s==='watched') confetti({particleCount:100,spread:70,origin:{y:0.6}}); };
        function updateStatusUI(){ const w=document.getElementById('btn-watched'),t=document.getElementById('btn-towatch'),r=document.getElementById('rating-ui'); if(tempStatus==='watched'){ w.className="flex-1 py-3.5 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-500/20 transition transform scale-105"; t.className="flex-1 py-3.5 bg-slate-800 text-gray-400 rounded-xl font-bold flex items-center justify-center gap-2 transition"; if(tempItem.type==='movie')r.classList.remove('hidden'); } else { w.className="flex-1 py-3.5 bg-slate-800 text-gray-400 rounded-xl font-bold flex items-center justify-center gap-2 transition"; t.className="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20 transition transform scale-105"; r.classList.add('hidden'); } renderStars(); }
        window.rate=(n)=>{tempRating=n;renderStars();}; function renderStars(){document.querySelectorAll('.star').forEach((s,i)=>s.className=i<tempRating?"ph-fill ph-star text-3xl star text-yellow-400 click-bounce":"ph-fill ph-star text-3xl star text-slate-700");}
        function initSeasons(t){const l=document.getElementById('season-list');l.innerHTML='';for(let i=1;i<=t;i++){const b=document.createElement('button');b.innerText=i;b.className=`flex-shrink-0 w-9 h-9 rounded-lg font-bold text-xs transition border border-white/5 ${i===tempProgress.s?'bg-blue-600 text-white shadow-lg':'bg-slate-800 text-gray-400'}`;b.onclick=()=>loadEps(i);l.appendChild(b);}loadEps(tempProgress.s);}
        async function loadEps(s){Array.from(document.getElementById('season-list').children).forEach(b=>b.className=parseInt(b.innerText)===s?'flex-shrink-0 w-9 h-9 rounded-lg font-bold text-xs bg-blue-600 text-white shadow-lg transition border border-white/5':'flex-shrink-0 w-9 h-9 rounded-lg font-bold text-xs bg-slate-800 text-gray-400 transition border border-white/5');if(!seasonCache[s])seasonCache[s]=await fetch(`${BASE_URL}/tv/${tempItem.tmdb_id}/season/${s}?api_key=${API_KEY}&language=fr-FR`).then(r=>r.json());const l=document.getElementById('episode-list');l.innerHTML='';seasonCache[s].episodes.forEach((ep,idx)=>{const isSeen=(s<tempProgress.s)||(s===tempProgress.s&&ep.episode_number<=tempProgress.e);const d=document.createElement('div');d.className=`flex justify-between items-center p-2.5 rounded-lg cursor-pointer ${isSeen?'bg-blue-900/20 border border-blue-500/20':'bg-slate-800 hover:bg-slate-700'}`;d.innerHTML=`<div class="flex items-center gap-3 overflow-hidden"><span class="text-xs font-bold text-gray-500 w-5">${ep.episode_number}</span><span class="text-xs font-medium text-white truncate">${ep.name}</span></div><i class="ph-fill ${isSeen?'ph-check-circle text-blue-500':'ph-circle text-gray-600'} text-lg"></i>`;d.onclick=()=>{tempProgress={s:s,e:ep.episode_number};const lastEp=(idx===seasonCache[s].episodes.length-1);if(lastEp&&s===tempItem.number_of_seasons){tempStatus='finished';tempNext=null;document.getElementById('status-badge').classList.remove('hidden');confetti({particleCount:150,spread:100,origin:{y:0.6}});}else{tempStatus='series_active';document.getElementById('status-badge').classList.add('hidden');tempNext=lastEp?{s:s+1,e:1}:{s:s,e:ep.episode_number+1};}tempEpsWatched=((s-1)*10)+ep.episode_number;loadEps(s);};l.appendChild(d);});}
        window.saveItem = () => { if(!tempItem)return; const item={tmdb_id:tempItem.tmdb_id,title:tempItem.title||tempItem.name||"?",type:tempItem.type,poster:tempItem.poster_path||null,backdrop:tempItem.backdrop_path||null,runtime:tempItem.runtime||0,status:tempItem.type==='movie'?tempStatus:(tempStatus||'series_active'),rating:tempRating||0,progress:tempItem.type==='tv'?(tempProgress||null):null,next:tempItem.type==='tv'?(tempNext||null):null,epsWatched:tempItem.type==='tv'?(tempEpsWatched||0):0};const idx=library.findIndex(i=>i.tmdb_id===item.tmdb_id);if(idx>=0)library[idx]=item;else library.unshift(item);localStorage.setItem(DB_KEY,JSON.stringify(library));saveToCloud();refreshStats();renderLibrary();closeModal();window.switchTab(currentTab==='search'?'home':currentTab); };
        window.toggleSettings=()=>document.getElementById('settings-modal').classList.toggle('hidden'); window.resetAll=()=>{if(confirm("Effacer tout ?")){localStorage.removeItem(DB_KEY);location.reload();}};
        window.exportData = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(library)); const dlAnchorElem = document.createElement('a'); dlAnchorElem.setAttribute("href", dataStr); dlAnchorElem.setAttribute("download", "cinetrack_backup.json"); dlAnchorElem.click(); };
        window.importData = (input) => { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if(Array.isArray(data)){ library = data; localStorage.setItem(DB_KEY, JSON.stringify(library)); saveToCloud(); alert("Restauration réussie !"); location.reload(); } else alert("Fichier invalide"); } catch(err){ alert("Erreur fichier"); } }; reader.readAsText(file); };
        function refreshStats() { let m=0,e=0,t=0; library.forEach(i=>{ if(i.type==='movie'&&i.status==='watched'){m++;t+=(i.runtime||0);} if(i.type==='tv'){e+=(i.epsWatched||0);t+=((i.epsWatched||0)*(i.runtime||40));} }); document.getElementById('stat-movies').innerText=m; document.getElementById('stat-eps').innerText=e; document.getElementById('stat-time').innerText=`${Math.floor(t/60)}h`; }
        if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>
