<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CineTrack</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- LAYOUT GLOBAL --- */
        html { background-color: #0f172a; height: 100%; }
        body {
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: row; 
        }

        /* --- SIDEBAR --- */
        .glass-sidebar {
            width: 64px;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: 20px;
            z-index: 40;
            flex-shrink: 0;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s;
            margin-bottom: 16px;
        }
        .nav-btn.active {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
        }
        .nav-btn:active { transform: scale(0.9); }

        /* --- CONTENU --- */
        .main-content {
            flex: 1;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- DASHBOARD --- */
        .dashboard-bar {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 12px 0;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .dash-item { text-align: center; flex: 1; position: relative; }
        .dash-item:not(:last-child)::after {
            content: ''; position: absolute; right: 0; top: 20%; height: 60%; width: 1px; background: rgba(255,255,255,0.1);
        }
        .dash-val { font-size: 16px; font-weight: 800; color: white; line-height: 1.2; }
        .dash-lbl { font-size: 9px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- GRID --- */
        .smart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        /* --- ANIMATIONS --- */
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .click-bounce:active { transform: scale(0.95); transition: 0.1s; }

        /* --- UTILS --- */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pt-safe { padding-top: max(20px, env(safe-area-inset-top)); }
        
        .btn-gradient {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .google-btn { background: white; color: #1f2937; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; transition: all 0.2s; }
    </style>
</head>
<body>

    <nav class="glass-sidebar">
        <div class="mb-8 mt-4 text-blue-500"><i class="ph-fill ph-film-strip text-3xl"></i></div>
        <div class="flex-1 flex flex-col justify-center w-full items-center">
            <button onclick="window.switchTab('library')" id="nav-library" class="nav-btn active"><i class="ph-bold ph-house text-xl"></i></button>
            <button onclick="window.switchTab('search')" id="nav-search" class="nav-btn"><i class="ph-bold ph-magnifying-glass text-xl"></i></button>
        </div>
        <button onclick="window.toggleSettings()" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:text-white transition mt-auto active:bg-white/10"><i class="ph-bold ph-gear text-lg"></i></button>
    </nav>

    <div class="main-content">
        
        <header class="pt-safe px-5 pb-2 flex justify-between items-center z-30 bg-gradient-to-b from-[#0f172a] via-[#0f172a]/80 to-transparent">
            <div>
                <h1 class="text-xl font-black tracking-tight text-white flex items-center gap-2">
                    CinéTrack <span id="online-indicator" class="hidden w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></span>
                </h1>
            </div>
            <div id="header-avatar" class="hidden w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center text-[10px] font-bold ring-2 ring-white/10">U</div>
        </header>

        <div id="view-library" class="flex-1 overflow-y-auto hide-scroll p-4 pb-10">
            <div class="dashboard-bar mb-6 animate-pop" style="animation-delay: 0ms">
                <div class="dash-item"><p id="stat-movies" class="dash-val">0</p><p class="dash-lbl">Films</p></div>
                <div class="dash-item"><p id="stat-eps" class="dash-val">0</p><p class="dash-lbl">Épisodes</p></div>
                <div class="dash-item"><p id="stat-time" class="dash-val text-blue-400">0h</p><p class="dash-lbl">Temps</p></div>
            </div>

            <div class="flex gap-2 mb-6 overflow-x-auto hide-scroll animate-pop" style="animation-delay: 50ms">
                <button onclick="window.setFilter('all')" id="filter-all" class="px-4 py-1.5 rounded-full text-[11px] font-bold bg-white text-black shadow-lg transition">Tout</button>
                <button onclick="window.setFilter('towatch')" id="filter-towatch" class="px-4 py-1.5 rounded-full text-[11px] font-bold bg-slate-800 text-gray-400 border border-white/5 transition">À voir</button>
                <button onclick="window.setFilter('series')" id="filter-series" class="px-4 py-1.5 rounded-full text-[11px] font-bold bg-slate-800 text-gray-400 border border-white/5 transition">Séries</button>
                <button onclick="window.setFilter('movies')" id="filter-movies" class="px-4 py-1.5 rounded-full text-[11px] font-bold bg-slate-800 text-gray-400 border border-white/5 transition">Films</button>
            </div>

            <div id="resume-section" class="hidden mb-6 animate-pop" style="animation-delay: 100ms">
                <h2 class="text-[10px] font-bold text-blue-400 uppercase mb-3 flex items-center gap-1.5 px-1 tracking-wider"><i class="ph-fill ph-play-circle"></i> Reprendre</h2>
                <div id="resume-list" class="flex gap-3 overflow-x-auto hide-scroll pb-2 px-1"></div>
            </div>

            <div id="library-grid" class="smart-grid animate-pop" style="animation-delay: 150ms"></div>

            <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-12 opacity-50">
                <div class="w-14 h-14 bg-slate-800 rounded-full flex items-center justify-center mb-3"><i class="ph-duotone ph-film-strip text-2xl text-gray-400"></i></div>
                <p class="text-xs font-bold text-gray-400">Bibliothèque vide</p>
                <button onclick="window.switchTab('search')" class="mt-4 px-5 py-2 bg-blue-600 rounded-full text-xs font-bold click-bounce">Ajouter</button>
            </div>
        </div>

        <div id="view-search" class="hidden flex-1 overflow-y-auto hide-scroll p-4 pb-10">
            <h2 class="text-2xl font-black mb-4 px-1">Explorer</h2>
            <div class="relative mb-6">
                <input type="text" id="search-input" placeholder="Titanic, Breaking Bad..." class="w-full bg-slate-800 text-white p-3.5 pl-11 rounded-xl border border-white/10 focus:border-blue-500 outline-none text-base font-bold shadow-inner">
                <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg"></i>
            </div>
            <div id="search-loader" class="hidden flex justify-center py-10"><i class="ph-duotone ph-spinner animate-spin text-3xl text-blue-500"></i></div>
            <div id="search-results" class="space-y-2"></div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-50 hidden transition-opacity duration-300" onclick="window.closeModal()"></div>
    <div id="modal-sheet" class="fixed bottom-0 right-0 w-full sm:w-[500px] h-[95vh] bg-[#0f172a] rounded-t-[32px] sm:rounded-l-[32px] sm:rounded-tr-none z-50 transform translate-y-full sm:translate-x-full sm:translate-y-0 transition-transform duration-300 flex flex-col shadow-2xl border-l border-white/10">
        <div class="relative w-full h-64 flex-shrink-0">
            <img id="m-img" src="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-transparent"></div>
            <button onclick="window.closeModal()" class="absolute top-4 right-4 w-9 h-9 bg-black/40 backdrop-blur rounded-full flex items-center justify-center text-white click-bounce"><i class="ph-bold ph-x"></i></button>
            <div class="absolute bottom-0 w-full p-6">
                <h2 id="m-title" class="text-2xl font-black leading-tight mb-2 text-white drop-shadow-lg">Titre</h2>
                <div class="flex gap-2 text-xs font-bold text-gray-300">
                    <span id="m-year" class="bg-white/10 px-2 py-0.5 rounded backdrop-blur">2024</span>
                    <span id="m-type" class="bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded backdrop-blur border border-blue-500/20">FILM</span>
                    <span id="m-runtime" class="bg-white/10 px-2 py-0.5 rounded backdrop-blur">120m</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 bg-[#0f172a]">
            <div class="grid grid-cols-2 gap-3 mb-8">
                <button onclick="window.setStatus('watched')" id="btn-watched" class="py-3.5 bg-slate-800 rounded-xl font-bold text-gray-400 flex items-center justify-center gap-2 click-bounce transition border border-white/5"><i class="ph-bold ph-check-circle"></i> Vu</button>
                <button onclick="window.setStatus('towatch')" id="btn-towatch" class="py-3.5 bg-slate-800 rounded-xl font-bold text-gray-400 flex items-center justify-center gap-2 click-bounce transition border border-white/5"><i class="ph-bold ph-eye"></i> À voir</button>
            </div>

            <div id="series-ui" class="hidden mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Saisons</h3>
                    <span id="status-badge" class="hidden text-[10px] font-black bg-gradient-to-r from-yellow-400 to-orange-500 text-black px-2 py-0.5 rounded shadow-lg shadow-orange-500/20">TERMINÉE</span>
                </div>
                <div id="season-list" class="flex gap-2 overflow-x-auto hide-scroll mb-3"></div>
                <div id="episode-list" class="space-y-1.5"></div>
            </div>

            <div id="rating-ui" class="hidden mb-8 bg-slate-900/50 p-4 rounded-xl text-center border border-white/5">
                <p class="text-[10px] font-bold text-gray-500 uppercase mb-3">Ma Note</p>
                <div class="flex justify-center gap-3">
                    <i onclick="window.rate(1)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(2)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(3)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(4)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                    <i onclick="window.rate(5)" class="ph-fill ph-star text-3xl star text-slate-700 transition click-bounce"></i>
                </div>
            </div>

            <div class="mb-24">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-widest">Casting</h3>
                <div id="cast-list" class="flex gap-3 overflow-x-auto hide-scroll"></div>
            </div>
        </div>

        <div class="absolute bottom-6 left-6 right-6 z-20">
            <button onclick="window.saveItem()" class="w-full py-3.5 btn-gradient text-white font-black text-base rounded-xl shadow-xl click-bounce flex items-center justify-center gap-2">Enregistrer <i class="ph-bold ph-arrow-right"></i></button>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-6" onclick="window.toggleSettings()">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl p-6 border border-white/10 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-lg font-bold mb-4 text-white">Réglages & Synchro</h2>
            <div id="user-info" class="mb-6 hidden text-center">
                <div class="w-14 h-14 rounded-full bg-blue-500 mx-auto mb-2 flex items-center justify-center text-xl font-bold text-white uppercase" id="user-avatar">?</div>
                <p id="user-email" class="text-xs font-bold text-white"></p>
                <p class="text-[10px] text-green-400 mt-1 uppercase font-bold">● Connecté</p>
            </div>
            <div class="space-y-3">
                <button id="btn-login" onclick="window.loginGoogle()" class="w-full py-3 google-btn rounded-xl text-xs shadow-lg"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4"> Se connecter avec Google</button>
                <button id="btn-logout" onclick="window.logoutGoogle()" class="hidden w-full py-3 bg-slate-800 rounded-xl font-bold text-xs text-gray-300 border border-white/10">Se déconnecter</button>
                <hr class="border-white/10 my-4">
                <button onclick="window.resetAll()" class="w-full py-3 text-red-500 font-bold text-xs border border-red-500/20 rounded-xl">Vider le cache</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBasFR8ZaxPt05lU6TgGEz_Qf-hnzV6_No",
            authDomain: "cinetrack-dd7c1.firebaseapp.com",
            projectId: "cinetrack-dd7c1",
            storageBucket: "cinetrack-dd7c1.firebasestorage.app",
            messagingSenderId: "816079795855",
            appId: "1:816079795855:web:d5e620ca45d7ed685222fa"
        };

        let app, auth, db, user = null;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase OK");
        } catch(e) { console.warn("Firebase Init Error", e); }

        const API_KEY = '3fd2be6f0c70a2a598f084ddfb75487c';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/w300';
        const IMG_HD = 'https://image.tmdb.org/t/p/w780';
        const DB_KEY = 'cinetrack_v27_secure';

        let library = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let tempItem, tempStatus, tempRating, tempProgress, tempNext, tempEpsWatched;
        let currentFilter = 'all';
        let seasonCache = {};

        window.loginGoogle = async () => {
            if(!auth) return alert("Firebase non configuré.");
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); window.toggleSettings(); } 
            catch(e) { alert("Erreur connexion: " + e.message); }
        };

        window.logoutGoogle = async () => {
            if(!auth) return;
            await signOut(auth); user = null; updateUserUI(); alert("Déconnecté."); window.toggleSettings();
        };

        if(auth) {
            onAuthStateChanged(auth, async (u) => {
                user = u; updateUserUI();
                if (user) {
                    try {
                        const docRef = doc(db, "users", user.uid);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            library = docSnap.data().library || [];
                            localStorage.setItem(DB_KEY, JSON.stringify(library));
                            renderLibrary(); refreshStats();
                        } else { saveToCloud(); }
                    } catch(e) { console.error(e); }
                }
            });
        }

        async function saveToCloud() {
            if (user && db) {
                try { 
                    // IMPORTANT: On utilise library qui est déjà nettoyé par saveItem
                    // On ne devrait pas avoir de undefined ici si saveItem fait son job
                    await setDoc(doc(db, "users", user.uid), { library: library });
                } catch(e) { alert("Erreur Cloud: " + e.message); }
            }
        }

        function updateUserUI() {
            const ind = document.getElementById('online-indicator');
            const hAvatar = document.getElementById('header-avatar');
            const info = document.getElementById('user-info');
            const btnIn = document.getElementById('btn-login');
            const btnOut = document.getElementById('btn-logout');
            if(user) {
                ind.classList.remove('hidden');
                hAvatar.classList.remove('hidden'); hAvatar.innerText = user.email[0].toUpperCase();
                info.classList.remove('hidden'); btnIn.classList.add('hidden'); btnOut.classList.remove('hidden');
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('user-avatar').innerText = user.email[0].toUpperCase();
            } else {
                ind.classList.add('hidden'); hAvatar.classList.add('hidden');
                info.classList.add('hidden'); btnIn.classList.remove('hidden'); btnOut.classList.add('hidden');
            }
        }

        window.switchTab = (t) => {
            ['library','search'].forEach(v=>{
                document.getElementById('view-'+v).classList.add('hidden');
                document.getElementById('nav-'+v).classList.remove('active');
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('nav-'+t).classList.add('active');
            if(t==='library') { refreshStats(); renderLibrary(); }
            if(t==='search') setTimeout(()=>document.getElementById('search-input').focus(), 100);
        };

        window.setFilter = (f) => {
            currentFilter=f;
            ['all','towatch','series','movies'].forEach(k=>{
                const b=document.getElementById('filter-'+k);
                b.className=(k===f)?"px-4 py-1.5 rounded-full text-[11px] font-bold bg-white text-black shadow-lg transition transform scale-105":"px-4 py-1.5 rounded-full text-[11px] font-bold bg-slate-800 text-gray-400 border border-white/5 transition";
            });
            renderLibrary();
        };

        function renderLibrary() {
            const grid=document.getElementById('library-grid'), hero=document.getElementById('resume-section'), heroList=document.getElementById('resume-list');
            grid.innerHTML=''; heroList.innerHTML='';
            const active=library.filter(i=>i.type==='tv'&&i.status==='series_active');
            let main=library.filter(i=>!active.includes(i));
            if(currentFilter==='movies') main=main.filter(i=>i.type==='movie');
            if(currentFilter==='series') main=main.filter(i=>i.type==='tv');
            if(currentFilter==='towatch') main=main.filter(i=>i.status==='towatch');

            if(active.length>0 && currentFilter==='all') {
                hero.classList.remove('hidden');
                active.forEach(i=>{
                    const d=document.createElement('div');
                    d.className="flex-shrink-0 w-48 h-28 bg-slate-800 rounded-xl relative overflow-hidden snap-start shadow-lg border border-white/5 cursor-pointer";
                    const img = i.backdrop?IMG_HD+i.backdrop:(i.poster?IMG_URL+i.poster:'');
                    d.innerHTML=`<img src="${img}" class="w-full h-full object-cover opacity-60" onerror="this.style.display='none'"><div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div><div class="absolute bottom-2 left-3 right-3"><p class="text-[9px] font-bold text-blue-400 uppercase mb-0.5">S${i.next.s} EP${i.next.e}</p><p class="text-white font-bold truncate text-xs">${i.title}</p></div>`;
                    d.onclick=()=>openDetails(i.tmdb_id, 'tv'); heroList.appendChild(d);
                });
            } else hero.classList.add('hidden');

            if(main.length===0 && active.length===0) document.getElementById('empty-state').classList.remove('hidden');
            else document.getElementById('empty-state').classList.add('hidden');

            main.forEach(i=>{
                const d=document.createElement('div'); d.className="relative aspect-[2/3] bg-slate-800 rounded-xl overflow-hidden shadow-lg animate-pop cursor-pointer";
                const img=i.poster?IMG_URL+i.poster:'';
                let b=''; if(i.status==='towatch')b=`<div class="absolute top-2 right-2 w-2 h-2 bg-blue-500 rounded-full shadow-[0_0_8px_#3b82f6]"></div>`;
                if(i.status==='finished')b=`<div class="absolute top-2 right-2 px-1 py-0.5 bg-yellow-400 text-black text-[7px] font-black rounded shadow">FINI</div>`;
                d.innerHTML=`<img src="${img}" class="w-full h-full object-cover opacity-90" onerror="this.style.display='none'">${b}<button class="absolute inset-0" onclick="window.openDetails('${i.tmdb_id}','${i.type}')"></button>`;
                grid.appendChild(d);
            });
        }

        function refreshStats() {
            let m=0,e=0,t=0;
            library.forEach(i=>{
                if(i.type==='movie'&&i.status==='watched'){m++;t+=(i.runtime||0);}
                if(i.type==='tv'){e+=(i.epsWatched||0);t+=((i.epsWatched||0)*(i.runtime||40));}
            });
            document.getElementById('stat-movies').innerText=m; document.getElementById('stat-eps').innerText=e; document.getElementById('stat-time').innerText=`${Math.floor(t/60)}h`;
        }

        let timer;
        document.getElementById('search-input').addEventListener('input', (e)=>{
            clearTimeout(timer);
            if(e.target.value.length>2) {
                document.getElementById('search-loader').classList.remove('hidden'); document.getElementById('search-results').innerHTML='';
                timer=setTimeout(()=>doSearch(e.target.value),500);
            }
        });
        async function doSearch(q){
            try{
                const r=await fetch(`${BASE_URL}/search/multi?api_key=${API_KEY}&language=fr-FR&query=${encodeURIComponent(q)}&include_adult=false`);
                const d=await r.json(); document.getElementById('search-loader').classList.add('hidden');
                const l=document.getElementById('search-results'); l.innerHTML='';
                d.results.filter(i=>(i.media_type==='movie'||i.media_type==='tv')&&i.poster_path).forEach(i=>{
                    const div=document.createElement('div'); div.className="flex items-center gap-3 p-2 bg-slate-800/50 rounded-xl border border-white/5 cursor-pointer active:scale-95 transition";
                    div.innerHTML=`<img src="${IMG_URL+i.poster_path}" class="w-10 h-14 rounded-lg object-cover bg-black"><div class="flex-1"><h4 class="font-bold text-white text-sm leading-tight">${i.media_type==='movie'?i.title:i.name}</h4><p class="text-[10px] text-gray-400 mt-0.5 uppercase font-bold">${i.media_type==='movie'?'Film':'Série'} • ${(i.release_date||i.first_air_date||'').slice(0,4)}</p></div>`;
                    div.onclick=()=>window.openDetails(i.id,i.media_type); l.appendChild(div);
                });
            }catch(e){}
        }

        window.openDetails = async (id, type) => {
            const [d,c] = await Promise.all([
                fetch(`${BASE_URL}/${type}/${id}?api_key=${API_KEY}&language=fr-FR`).then(r=>r.json()),
                fetch(`${BASE_URL}/${type}/${id}/credits?api_key=${API_KEY}&language=fr-FR`).then(r=>r.json())
            ]);
            tempItem={...d,type,tmdb_id:d.id.toString(),cast:c.cast?.slice(0,10)||[]};
            const ex=library.find(i=>i.tmdb_id===tempItem.tmdb_id);
            if(ex){tempStatus=ex.status;tempRating=ex.rating||0;tempProgress=ex.progress||{s:1,e:0};tempNext=ex.next||{s:1,e:1};tempEpsWatched=ex.epsWatched||0;}
            else{tempStatus='towatch';tempRating=0;tempProgress={s:1,e:0};tempNext={s:1,e:1};tempEpsWatched=0;}

            document.getElementById('m-title').innerText=type==='movie'?d.title:d.name;
            document.getElementById('m-year').innerText=(type==='movie'?d.release_date:d.first_air_date)?.slice(0,4);
            document.getElementById('m-type').innerText=type==='movie'?'FILM':'SÉRIE';
            document.getElementById('m-runtime').innerText=type==='movie'?d.runtime+'m':(d.episode_run_time?.[0]||45)+'m';
            document.getElementById('m-img').src=d.backdrop_path?IMG_HD+d.backdrop_path:IMG_URL+d.poster_path;
            const cl=document.getElementById('cast-list'); cl.innerHTML='';
            tempItem.cast.forEach(a=>{if(a.profile_path)cl.innerHTML+=`<div class="flex-shrink-0 w-14 text-center"><img src="${IMG_URL+a.profile_path}" class="w-12 h-12 rounded-full object-cover mx-auto mb-1 bg-slate-800"><p class="text-[8px] text-gray-400 truncate">${a.name}</p></div>`;});

            if(type==='tv'){
                document.getElementById('series-ui').classList.remove('hidden'); document.getElementById('rating-ui').classList.add('hidden');
                seasonCache={}; initSeasons(d.number_of_seasons);
                document.getElementById('status-badge').classList.toggle('hidden', tempStatus!=='finished');
            } else {
                document.getElementById('series-ui').classList.add('hidden'); updateStatusUI();
            }
            document.getElementById('modal-overlay').classList.remove('hidden');
            const sheet = document.getElementById('modal-sheet');
            sheet.classList.remove('translate-y-full', 'sm:translate-x-full');
        };

        window.closeModal = () => {
            const sheet = document.getElementById('modal-sheet');
            if(window.innerWidth >= 640) sheet.classList.add('sm:translate-x-full'); else sheet.classList.add('translate-y-full');
            setTimeout(()=>document.getElementById('modal-overlay').classList.add('hidden'),300);
        };

        window.setStatus = (s) => { tempStatus=s; updateStatusUI(); if(s==='watched') confetti({particleCount:100,spread:70,origin:{y:0.6}}); };
        function updateStatusUI(){
            const w=document.getElementById('btn-watched'),t=document.getElementById('btn-towatch'),r=document.getElementById('rating-ui');
            if(tempStatus==='watched'){
                w.className="flex-1 py-3.5 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-500/20 transition transform scale-105";
                t.className="flex-1 py-3.5 bg-slate-800 text-gray-400 rounded-xl font-bold flex items-center justify-center gap-2 transition";
                if(tempItem.type==='movie')r.classList.remove('hidden');
            } else {
                w.className="flex-1 py-3.5 bg-slate-800 text-gray-400 rounded-xl font-bold flex items-center justify-center gap-2 transition";
                t.className="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20 transition transform scale-105";
                r.classList.add('hidden');
            }
            renderStars();
        }

        window.rate = (n) => { tempRating=n; renderStars(); };
        function renderStars() { document.querySelectorAll('.star').forEach((s,i)=>s.className=i<tempRating?"ph-fill ph-star text-3xl star text-yellow-400 click-bounce":"ph-fill ph-star text-3xl star text-slate-700"); }

        function initSeasons(total) {
            const l=document.getElementById('season-list'); l.innerHTML='';
            for(let i=1;i<=total;i++){
                const b=document.createElement('button'); b.innerText=i;
                b.className=`flex-shrink-0 w-9 h-9 rounded-lg font-bold text-xs transition border border-white/5 ${i===tempProgress.s?'bg-blue-600 text-white shadow-lg':'bg-slate-800 text-gray-400'}`;
                b.onclick=()=>loadEps(i); l.appendChild(b);
            }
            loadEps(tempProgress.s);
        }

        async function loadEps(sNum) {
            Array.from(document.getElementById('season-list').children).forEach(b=>b.className=parseInt(b.innerText)===sNum?'flex-shrink-0 w-9 h-9 rounded-lg font-bold text-xs bg-blue-600 text-white shadow-lg transition border border-white/5':'flex-shrink-0 w-9 h-9 rounded-lg font-bold text-xs bg-slate-800 text-gray-400 transition border border-white/5');
            if(!seasonCache[sNum]){const r=await fetch(`${BASE_URL}/tv/${tempItem.tmdb_id}/season/${sNum}?api_key=${API_KEY}&language=fr-FR`); seasonCache[sNum]=await r.json();}
            const l=document.getElementById('episode-list'); l.innerHTML='';
            seasonCache[sNum].episodes.forEach((ep,idx)=>{
                const isSeen=(sNum<tempProgress.s)||(sNum===tempProgress.s && ep.episode_number<=tempProgress.e);
                const d=document.createElement('div'); d.className=`flex justify-between items-center p-2.5 rounded-lg cursor-pointer ${isSeen?'bg-blue-900/20 border border-blue-500/20':'bg-slate-800 hover:bg-slate-700'}`;
                d.innerHTML=`<div class="flex items-center gap-3 overflow-hidden"><span class="text-xs font-bold text-gray-500 w-5">${ep.episode_number}</span><span class="text-xs font-medium text-white truncate">${ep.name}</span></div><i class="ph-fill ${isSeen?'ph-check-circle text-blue-500':'ph-circle text-gray-600'} text-lg"></i>`;
                d.onclick=()=>{
                    tempProgress={s:sNum,e:ep.episode_number};
                    const lastEp=(idx===seasonCache[sNum].episodes.length-1);
                    if(lastEp && sNum===tempItem.number_of_seasons){
                        tempStatus='finished';tempNext=null;
                        document.getElementById('status-badge').classList.remove('hidden');
                        confetti({particleCount:150,spread:100,origin:{y:0.6}});
                    } else {
                        tempStatus='series_active';
                        document.getElementById('status-badge').classList.add('hidden');
                        tempNext=lastEp?{s:sNum+1,e:1}:{s:sNum,e:ep.episode_number+1};
                    }
                    tempEpsWatched=((sNum-1)*10)+ep.episode_number; loadEps(sNum);
                };
                l.appendChild(d);
            });
        }

        // --- CORRECTION CRITIQUE (Sanitization) ---
        window.saveItem = () => {
            if(!tempItem) return;
            // On force les valeurs par défaut (null ou 0) pour éviter "undefined"
            const item = {
                tmdb_id: tempItem.tmdb_id,
                title: tempItem.title || tempItem.name || "Titre inconnu",
                type: tempItem.type,
                poster: tempItem.poster_path || null,
                backdrop: tempItem.backdrop_path || null,
                runtime: tempItem.runtime || 0,
                status: tempItem.type==='movie' ? tempStatus : (tempStatus || 'series_active'),
                rating: tempRating || 0,
                progress: tempItem.type==='tv' ? (tempProgress || null) : null,
                next: tempItem.type==='tv' ? (tempNext || null) : null,
                epsWatched: tempItem.type==='tv' ? (tempEpsWatched || 0) : 0
            };
            const idx = library.findIndex(i => i.tmdb_id === item.tmdb_id);
            if(idx >= 0) library[idx] = item; else library.unshift(item);
            
            localStorage.setItem(DB_KEY, JSON.stringify(library));
            saveToCloud();
            refreshStats();
            renderLibrary();
            closeModal();
            window.switchTab('library');
        };

        window.toggleSettings=()=>document.getElementById('settings-modal').classList.toggle('hidden');
        window.resetAll=()=>{if(confirm("Effacer tout ?")){localStorage.removeItem(DB_KEY);location.reload();}};

        // PWA SW
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
